#include "gro_util.hpp"

int Gro::cnt = 0;
Gro::Gro(){
    cnt++;
    this->resnr = ' ';
    this->resname = ' ';
    this->atomname = ' ';
    this->num = cnt;
    this->r[0] = 0.0;
    this->r[1] = 0.0;
    this->r[2] = 0.0;
}

Gro::~Gro(){
    cnt--;
}

void Gro::set_params(int resnr, string resname, string atomname, int num, double x, double y, double z){
    this->resnr = resnr;
    this->resname = trim(resname, ' ');
    this->atomname = trim(atomname, ' ');
    this->num = num;
    this->r[0] = x;
    this->r[1] = y;
    this->r[2] = z;
}

int Gro::get_params(){
#ifdef DEBUG
    cout << resname << " " <<atomname << endl;
#endif /* DEBUG */
    return num;
}



int get_n_atoms(string grofile){
    string buf;
    ifstream ifs(grofile);
    getline(ifs, buf);
    getline(ifs, buf);
    int n_atoms = stoi(buf);
    return n_atoms;
}

void read_gro(string grofile, int n_atoms,  Gro *gro, double *box){
    string buf;
    ifstream ifs(grofile);
    getline(ifs, buf);
    getline(ifs, buf);

    for (int i=0; i<n_atoms;i++){
        getline(ifs, buf);
        gro[i].set_params(
                            stoi(buf.substr(0,5)),
                            buf.substr(5,5),
                            buf.substr(10,5),
                            stoi(buf.substr(15,5)),
                            stof(buf.substr(20,8)),
                            stof(buf.substr(28,8)),
                            stof(buf.substr(36,8))
                           );
    }

    getline(ifs, buf);
    box[0] = stof(buf.substr(0,10));
    box[1] = stof(buf.substr(10,10));
    box[2] = stof(buf.substr(20,10));

}

void write_gro(string filename, int n_atoms, Gro *gro, double *box){
	ofstream ofs_out(filename);
	ofs_out << "this is generated by gro_util.cpp" << endl;
	ofs_out << n_atoms << endl;
	for (int i=0; i<n_atoms ; i++){
		ofs_out << setw(5) << right << gro[i].get_resnr()
		        << setw(5) << left << gro[i].get_resname()
		        << setw(5) << right << gro[i].get_atomname()
		        << setw(5) << right << gro[i].get_num()
		        << setw(8) << right << fixed << showpoint << setprecision(3) << gro[i].get_r(0)
		        << setw(8) << right << fixed << showpoint << setprecision(3) << gro[i].get_r(1)
		        << setw(8) << right << fixed << showpoint << setprecision(3) << gro[i].get_r(2)
		        << endl;
	}
	ofs_out << setw(10) << right << fixed << setprecision(5) << box[0]
	        << setw(10) << right << fixed << setprecision(5) << box[1]
	        << setw(10) << right << fixed << setprecision(5) << box[2]
	        << endl;
}
	
//int main(int argc, char **argv){
//    string filename = argv[1];
//    int n_atoms = get_n_atoms(filename);
//    double *box = new double[3];
//    Gro *gro = new Gro[n_atoms];
//
//    read_gro(filename ,n_atoms, gro, box);
//
//    cout << n_atoms << endl;
//    for (int i=0; i<n_atoms;i++){
//        gro[i].get_params();
//    }
//    cout << box[0] ;
//    cout << gro[0].get_r(2);
//
//	write_gro("out.gro", n_atoms, gro, box);
//
//    delete [] gro;
//    delete [] box;
//    return 0;
//}
